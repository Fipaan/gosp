<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gosp REPL</title>
<style>
body { font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; }
header { background: #333; color: #fff; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
#console { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; }
#inputArea { display: flex; padding: 10px; background: #eee; }
#inputArea textarea { flex: 1; height: 60px; }
#inputArea button { margin-left: 10px; }
.output-entry { margin-bottom: 10px; }
.output-entry .expr { font-weight: bold; }
</style>
</head>
<body>
<header>
  <div>Gosp REPL</div>
  <div>
    <button id="functionsBtn">Functions</button>
    <button id="logoutBtn">Logout</button>
  </div>
</header>
<div id="console"></div>
<div id="inputArea">
  <textarea id="replInput"></textarea>
  <button id="runBtn">Run</button>
</div>

<script>
const consoleEl = document.getElementById('console');
const inputEl = document.getElementById('replInput');

const authHeaders = () => {
  const cookie = document.cookie.split('; ').find(c => c.startsWith('authKey='));
  if (!cookie) return {};
  return { 'Authorization': 'Bearer ' + cookie.split('=')[1] };
};

const addToConsole = (expr, result) => {
  const div = document.createElement('div');
  div.className = 'output-entry';
  div.innerHTML = `<div class="expr">\`${expr}\` -></div><div class="result">${result}</div>`;
  consoleEl.appendChild(div);
  consoleEl.scrollTop = consoleEl.scrollHeight;
};

const loadHistory = async () => {
  try {
    const res = await fetch('/api/history', { headers: authHeaders() });
    const data = await res.json();
    if (data.items) {
      data.items.reverse().forEach(item => addToConsole(item.expr, item.result));
    }
  } catch(e) {}
};

const runExpr = async () => {
  const expr = inputEl.value.trim();
  if (!expr) return;
  inputEl.value = '';
  try {
    const res = await fetch('/api/expr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({ expr })
    });
    const data = await res.json();
    if (data.result) addToConsole(expr, data.result);
    else if (data.message) addToConsole(expr, 'Error: ' + data.message);
  } catch(e) {
    addToConsole(expr, 'Network error');
  }
};

document.getElementById('runBtn').addEventListener('click', runExpr);
inputEl.addEventListener('keydown', (e) => { if (e.shiftKey && e.key === 'Enter') runExpr(); });

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await fetch('/api/logout', { method: 'POST', headers: authHeaders() });
  document.cookie = 'authKey=; Max-Age=0; path=/';
  window.location.href = 'login.html';
});

document.getElementById('functionsBtn').addEventListener('click', () => {
  window.location.href = 'functions.html';
});

// check if redirected from functions page
const insertExpr = localStorage.getItem('insertExpr');
if (insertExpr) {
  inputEl.value = insertExpr;
  localStorage.removeItem('insertExpr');
}

loadHistory();
</script>
</body>
</html>
