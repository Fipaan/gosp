<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lisp REPL</title>
<style>
body {
    margin:0;
    font-family: Arial;
    background:#111;
    color:white;
    height:100vh;
    overflow:hidden;
}
.app {
    display:flex;
    height:100vh;
    width:100%;
}
.main {
    flex:1;
    display:flex;
    flex-direction:column;
    transition: width 0.3s;
}
.navbar {
    display:flex;
    align-items:center;
    padding:10px 20px;
    background:#1c1c1c;
}
.nav-left { 
    font-weight:bold; 
    font-size:18px; 
}
.nav-right { 
    display:flex; 
    align-items:center; 
    gap:10px; 
}
.container {
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    margin-top:20px;
    overflow:hidden;
}
#output {
    background:#222;
    padding:10px;
    width:80%;
    flex:1;
    overflow:auto;
    white-space: pre-wrap;
    font-family: monospace;
}
.output-block {
    position: relative;
    background:#333;
    padding:4px;
    margin-bottom:6px;
    border-radius:4px;
}
.output-insert {
    position: absolute;
    right: 4px;
    top: 4px;
    padding:2px 6px;
    font-size:12px;
    cursor:pointer;
    background:#00ffcc;
    color:#111;
    border-radius:3px;
    border:none;
}
.output-insert:hover { 
    background:#00d6a0; 
}
#codeContainer {
    margin-top:10px;
    display:flex;
    width:80%;
    gap:10px;
}
textarea { 
    flex:1; 
    height:80px; 
    background:#222; 
    color:white; 
    border:none; 
    padding:10px; 
    font-family:monospace; 
    resize:none;
}
button {
    background:#333;
    color:white;
    border:none;
    padding:8px 14px;
    cursor:pointer;
}
button:hover { 
    background:#555; 
}
#sidebar {
    width:0;
    background:#1b1b1b;
    overflow:hidden;
    transition: width 0.3s ease;
    display:flex;
    flex-direction:column;
}
#sidebar.active {
    width:350px;
    padding:20px;
}
.command {
    padding:8px 12px;
    margin-bottom:6px;
    background:#333;
    border-radius:4px;
    text-align:center;
    cursor:pointer;
}
.command:hover { 
    background:#00ffcc; 
    color:#111; 
}
</style>
</head>
<body>
<div class="app">
    <div class="main">
        <div class="navbar">
            <div class="nav-left">Gosp</div>
            <div style="flex:1"></div>
            <div class="nav-right">
                <span id="usernameDisplay"></span>
                <button onclick="toggleSidebar()">Info</button>
                <button id="authButton"></button>
            </div>
        </div>
        <div class="container">
            <div id="output"></div>
            <div id="codeContainer">
                <textarea id="codeInput" placeholder="Enter Lisp code..."></textarea>
                <button onclick="runCode()">Run</button>
            </div>
        </div>
    </div>
    <div id="sidebar"></div>
</div>
<script>
const token = localStorage.getItem("token");
const username = localStorage.getItem("username");
const usernameDisplay = document.getElementById("usernameDisplay");
const authButton = document.getElementById("authButton");
const outputDiv = document.getElementById("output");
const codeInput = document.getElementById("codeInput");
if (token) {
    usernameDisplay.textContent = username;
    authButton.textContent = "Logout";
    authButton.onclick = logout;
} else {
    authButton.textContent = "Login";
    authButton.onclick = () => window.location.href = "login.html";
}
function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    location.reload();
}
async function runCode(){
    const code = codeInput.value;
    if (!code.trim()) return;
    const res = await fetch("/api/expr", {
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Authorization": token ? "Bearer "+token : ""
        },
        body: JSON.stringify({expr: code})
    });
    let data;
    try { data = await res.json(); } 
    catch(e) { data = { result: null, error: "Invalid server response" }; }
    let outputs = [];
    if (data.result) {
        if (Array.isArray(data.result)) outputs.push(...data.result);
        else outputs.push(data.result);
    }
    if (data.error) {
        if (Array.isArray(data.error)) outputs.push(...data.error.map(e => "Error: " + e));
        else outputs.push("Error: " + data.error);
    }
    const codeBlock = document.createElement("div");
    codeBlock.className = "output-block";
    codeBlock.innerHTML = code.split("\n").map(l => `<div>${l}</div>`).join("");
    const insBtn = document.createElement("button");
    insBtn.className = "output-insert";
    insBtn.textContent = "Insert";
    insBtn.onclick = () => { codeInput.value += (codeInput.value ? "\n" : "") + code; codeInput.focus(); };
    codeBlock.appendChild(insBtn);
    outputDiv.appendChild(codeBlock);
    outputs.forEach(out => {
        const resDiv = document.createElement("div");
        resDiv.textContent = out;
        outputDiv.appendChild(resDiv);
    });
    outputDiv.appendChild(document.createElement("hr"));
    codeInput.value = "";
    outputDiv.scrollTop = outputDiv.scrollHeight;
}
codeInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); runCode(); }
});
const commands = {
    "+": { syntax:"(+ a b ...)", description:"Adds all arguments.", example:"(+ 1.2 2.3 3.4)" },
    "-": { syntax:"(- a b)", description:"Subtracts second from first.", example:"(- 10.5 3.2)" },
    "*": { syntax:"(* a b ...)", description:"Multiplies arguments.", example:"(* 2.1 3.5 4.0)" },
    "/": { syntax:"(/ a b)", description:"Divides first by second.", example:"(/ 8.2 2.1)" },
    "head": { syntax:"(head list)", description:"Returns first element of list.", example:"(head [1.1 2.2 3.3])" },
    "tail": { syntax:"(tail list)", description:"Returns list without first element.", example:"(tail [1.1 2.2 3.3])" },
    "<": { syntax:"(< a b)", description:"Checks if a < b.", example:"(< 5.5 10.2)" },
    ">": { syntax:"(> a b)", description:"Checks if a > b.", example:"(> 5.3 10.4)" },
    "=": { syntax:"(= a b)", description:"Checks equality.", example:"(= 5.5 5.5)" }
};
function toggleSidebar(){
    const sidebar = document.getElementById("sidebar");
    sidebar.classList.toggle("active");
    renderCommandList();
}
function renderCommandList(){
    const sidebar = document.getElementById("sidebar");
    sidebar.innerHTML = "<h3>Commands</h3>";
    for(let cmd in commands){
        sidebar.innerHTML += `<div class="command" onclick="showCommand('${cmd}')">${cmd}</div>`;
    }
}
function showCommand(cmd){
    const c = commands[cmd];
    const sidebar = document.getElementById("sidebar");
    sidebar.innerHTML = `
        <button onclick="renderCommandList()">‚Üê Back</button>
        <h3>${cmd}</h3>
        <p><b>Syntax:</b> ${c.syntax}</p>
        <p>${c.description}</p>
        <p><b>Example:</b> ${c.example}</p>
        <button onclick="codeInput.value += (codeInput.value?'\\n':'')+'${c.example}'">Insert</button>
    `;
}
</script>
</body>
</html>
